#!/bin/sh
#
# (c) 2009, Tonnerre Lombard <tonnerre@NetBSD.org>,
#	    The NetBSD Foundation. All rights reserved.
#
# Redistribution and use  in source and binary forms,  with or without
# modification, are  permitted provided that  the following conditions
# are met:
#
# * Redistributions  of source  code must  retain the  above copyright
#   notice, this list of conditions and the following disclaimer.
# * Redistributions in binary form  must reproduce the above copyright
#   notice, this  list of conditions  and the following  disclaimer in
#   the  documentation  and/or   other  materials  provided  with  the
#   distribution.
# * Neither the name of the The NetBSD  Foundation nor the name of its
#   contributors may  be used to  endorse or promote  products derived
#   from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED  BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES OF MERCHANTABILITY AND
# FITNESS FOR A  PARTICULAR PURPOSE ARE DISCLAIMED. IN  NO EVENT SHALL
# THE  COPYRIGHT  OWNER OR  CONTRIBUTORS  BE  LIABLE  FOR ANY  DIRECT,
# INDIRECT, INCIDENTAL,  SPECIAL, EXEMPLARY, OR  CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT  NOT LIMITED TO, PROCUREMENT OF  SUBSTITUTE GOODS OR
# SERVICES; LOSS  OF USE, DATA, OR PROFITS;  OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY  THEORY OF LIABILITY, WHETHER IN CONTRACT,
# STRICT  LIABILITY,  OR  TORT  (INCLUDING  NEGLIGENCE  OR  OTHERWISE)
# ARISING IN ANY WAY OUT OF  THE USE OF THIS SOFTWARE, EVEN IF ADVISED
# OF THE POSSIBILITY OF SUCH DAMAGE.
#
# $patchadd$
#

## Basic definitions

OPENSSL="@OPENSSL@"
TAR="@TAR@"
OSABI=`uname -s`
OSVERS=`uname -r`
OSARCH=`uname -m`
BSPATCH="@BSPATCH@"
BASENAME="@BASENAME@"
BSDIFF="@BSDIFF@"
CP="@CP@"
MV="@MV@"
RM="@RM@"
MKDIR="@CMD_MKDIR@"
AWK="@AWK@"
PULLUP_TRACKER_BASE="http://releng.netbsd.org/cgi-bin/req-{}.cgi"

exitcode=0

## Actual code

usage() {
	echo "$0 [-o <old-dir>|-p <plist-file>] [-m <machine-arch>]" 1>&2
	echo "        [-r <release>] [-k <keyfile>] <builddir> <pullup-id>" 1>&2
	echo 1>&2
	echo "    -o old-dir" 1>&2
	echo "        Directory containing the previous build, to generate" 1>&2
	echo "        a plist from." 1>&2
	echo "    -p plist-file" 1>&2
	echo "        PLIST file containing a list of files to diff." 1>&2
	echo "    -k keyfile" 1>&2
	echo "        Path to the patch signing key." 1>&2
	echo "    -s os-abi" 1>&2
	echo "        The OS ABI of the build, if differing." 1>&2
	echo "    -m machine-arch" 1>&2
	echo "        The architecture of the build, if differing." 1>&2
	echo "    -r release" 1>&2
	echo "        The release of the build, if differing." 1>&2
	exit 1
}

args=`getopt o:p:k:s:m:r: $*`
[ $? -eq 0 ] || usage

set -- $args

PLIST=''
ORIGDIR=''
KEYFILE=''

while [ $# -gt 0 ]
do
	case "$1" in
		-o)
			ORIGDIR="$2"
			shift
			;;
		-p)
			PLIST="$2"
			shift
			;;
		-s)
			OSABI="$2"
			shift
			;;
		-m)
			OSARCH="$2"
			shift
			;;
		-r)
			OSVERS="$2"
			shift
			;;
		-k)
			KEYFILE="$2"
			shift
			;;
		--)
			shift; break
			;;
	esac
	shift
done

if [ "$#" -lt 2 ]
then
	echo "Too few arguments." 1>&2
	usage
fi

OSMAJ=`echo "${OSVERS}" | awk -F. '{ print $1 }'`
OSFULL=`echo "${OSVERS}" | awk -F_ '{ print $1 }'`
PULLUP_TRACKER=`echo "${PULLUP_TRACKER_BASE}" | sed -e"s@{}@${OSMAJ}@g"`
BUILDDIR="$1"
PULLUP="$2"
shift; shift

if [ -z "${KEYFILE}" ]
then
	KEYFILE="/etc/openssl/private/${OSABI}.pem"
fi

if [ ! -f "${KEYFILE}" ]
then
	echo "Key file ${KEYFILE} not found." 1>&2
	usage
fi

if [ -z "${ORIGDIR}" ] && [ -z "${PLIST}" ]
then
	echo "Either -p or -o is required." 1>&2
	usage
fi

if [ -z "${PLIST}" ]
then
	echo "PLIST creation not supported yet. Sorry. :-/" 1>&2
	exit 23
fi

WRKDIR=`mktemp -d /tmp/mkpatch-XXXXXX`
OUTDIR=`pwd`

cat << EOT > "${WRKDIR}/+INFO"
ABI=${OSABI}
OS_VERSION=${OSFULL}
MACHINE_ARCH=${OSARCH}
PATCHTOOLS=0.1
NAME=${OSFULL}-${PULLUP}
COMMENT=Dummy text for pullup ${PULLUP}
EOT

cat << EOT > "${WRKDIR}/+COMMENT"
Dummy text for pullup ${PULLUP}
EOT

(while read file
do
	PFILE=`echo "${file}" | tr '/' '_' | sed -e's/^_//'`
	OSUM=`sha1 -n "${ORIGDIR}/${file}" | awk '{ print $1 }'`
	NSUM=`sha1 -n "${BUILDDIR}/${file}" | awk '{ print $1 }'`

	"${BSDIFF}" "${ORIGDIR}/${file}" "${BUILDDIR}/${file}" \
		"${WRKDIR}/${PFILE}"
	echo "${file}" "${PFILE}" "${OSUM}" "${NSUM}" "${OSUM}" >>	\
		"${WRKDIR}/+CONTENTS"
done) < "${PLIST}"

(cd "${WRKDIR}"; "${TAR}" cjvf "${OUTDIR}/${OSFULL}-${PULLUP}.tbz" *)
"${OPENSSL}" smime -sign -binary -outform PEM -signer "${KEYFILE}"	\
	-in "${OUTDIR}/${OSFULL}-${PULLUP}.tbz" -out			\
	"${OUTDIR}/${OSFULL}-${PULLUP}.tbz.sig"

exit $exitcode
